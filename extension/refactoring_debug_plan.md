# Refactoring Debug Plan: Fixing Validation Panel Issue Removal

## Project Goal

Refactor the monolithic `src/popup/popup.js` by extracting UI and logic into dedicated manager classes (`StatusBarManager`, `SearchManager`, `FeedManager`, `ValidationUIManager`).

## Current Status (April 2, 2025)

**Completed Refactoring:**
*   Logic for status bar, search, feed preview/parsing/editing, and validation UI display has been moved from `popup.js` to respective manager classes (`src/popup/*_manager.js`).
*   `popup.js` has been significantly cleaned, removing redundant methods and delegating calls to the managers.
*   Managers are instantiated correctly in `popup.js`, and dependencies (mostly) passed.
*   `popup.html` includes the necessary script tags for all managers.
*   Basic UI interactions are functional in Test Mode:
    *   Status bar updates (Connect/Logout).
    *   Feed preview loading and display.
    *   Basic search filtering.
    *   Validation triggering (via "Validate Feed" button).
    *   Validation panel (modal) dragging and closing.
    *   Tab switching ("Feed Preview" / "Validation History").
    *   Character count display (`current / min_length`) and color change (red/green based on 30/90 min lengths) in editable fields work correctly.
    *   "Go to Row" link correctly switches to the "Feed Preview" tab and scrolls to the target row.

**Critical Remaining Issue:**
*   **Issue Not Removed from Panel:** When a user edits an editable field (e.g., Title) in the feed preview table to satisfy the UI's length requirements (min 30), the corresponding issue entry in the floating validation panel is **NOT** removed, even though the UI feedback (green count, highlight removal) indicates the fix was detected.

**Secondary Issue (Likely Related & Validator Scope):**
*   **Validator Rule Discrepancy:** The list of issues initially displayed in the validation panel (generated by `GMCValidator` or its test data) seems based on different rules than the UI checks (e.g., title min length might be 25 in validator vs. 30 in UI; description min length of 90 might not be checked by validator). This causes confusion, like seeing valid fields flagged or invalid fields not flagged in the panel.
*   **`rowIndex` Mismatch:** Debugging revealed that the `rowIndex` reported in the validator's issue data (e.g., `rowIndex: 24`) does not match the visual row index in the table (`data-row="12"`). This is the most likely reason the `markIssueAsFixed` function fails, as it searches the panel using the incorrect `data-row` value passed from the table interaction.

## Debugging Steps Taken

*   Verified that `FeedManager.monitorFieldForFix` detects the UI fix based on 30/90 rules.
*   Verified that `FeedManager.monitorFieldForFix` calls `ValidationUIManager.markIssueAsFixed` with the `rowIndex` from the table's `data-row` attribute and the correct `fieldName`.
*   Verified that `ValidationUIManager.formatValidationIssues` correctly adds `data-row` and `data-field` attributes to the `.issue-item` elements in the panel based on the validator's results.
*   Verified that `ValidationUIManager.markIssueAsFixed` uses the correct selector (`.issue-item[data-row="..."][data-field="..."]`) and attempts to remove all matching elements.
*   Added console logging to trace the notification and removal process.

## Instructions for Next Agent

**Primary Goal:** Fix the issue where fixing a field in the table does not remove the corresponding error from the validation panel.

1.  **Confirm `rowIndex` Mismatch:**
    *   Run the extension in Test Mode.
    *   Load feed, Validate, View Issues.
    *   Use browser dev tools to inspect the validation panel HTML. Find an issue item (e.g., for visual Row 12 title) and check its `data-row` attribute. Compare this to the `rowIndex` shown in the console log for the `GMC Validation Results` object (expand the object logged by `ValidationUIManager`). Confirm they are different.
2.  **Trace the Values:**
    *   Use the existing console logs added in `FeedManager.monitorFieldForFix` and `ValidationUIManager.markIssueAsFixed`.
    *   Fix the title for visual Row 12 again.
    *   Observe the logs:
        *   Confirm `[FeedManager]` logs the correct visual `row.dataset.row` (e.g., '12') and `fieldToFix` ('title') being passed to `markIssueAsFixed`.
        *   Confirm `[ValidationUIManager]` logs that it's searching using the *incorrect* `rowIndex` (e.g., `data-row="12"`) received from `FeedManager`.
        *   Confirm `[ValidationUIManager]` logs the warning "Could not find issue item to remove..." because no element matches `data-row="12"` (the actual element has `data-row="24"` or similar from the validator).
3.  **Implement a Solution for `rowIndex`:**
    *   **Recommended:** Modify `ValidationUIManager.markIssueAsFixed`. Instead of directly using the `rowIndex` passed from `FeedManager`, it needs a way to find the panel item corresponding to the visual row that was *actually* fixed. This might involve:
        *   Searching the panel for items matching *only* the `fieldName` and then finding the one visually closest or associated with the currently focused/edited element (complex).
        *   Ideally, modifying the `GMCValidator` or test data (`lib/gmc/api.js`) to return the correct visual `rowIndex` in its results. This is the cleanest solution but involves editing other files.
        *   Alternatively, creating a mapping between the validator's `rowIndex` and the table's `data-row` when the panel is first generated, and using this map in `markIssueAsFixed`.
4.  **Test Thoroughly:** Ensure that fixing *any* title or description length issue correctly removes the corresponding item (and only that item) from the panel.

**Secondary Task (Optional - Requires Validator Changes):**
*   Update the rules in `lib/gmc/validator.js` (and potentially the mock data generation in `lib/gmc/api.js` test mode) to use the 30/90 minimum length requirements for titles and descriptions, so the initial validation results match the UI checks.